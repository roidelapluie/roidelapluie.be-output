<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="generator" content="Hugo 0.25.1" />

        <title>A classical pulp upgrade .... - Julien Pivotto</title>
    </head>
    <body class="bg-faded">
        <div class="bg-primary"><nav class="navbar navbar-toggleable-md navbar-inverse bg-primary container">
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="navbar-brand mb-0">roidelapluie</div>
        
        <div class="collapse navbar-collapse" id="navbarNav">
            <div class="navbar-nav mr-auto">
                
                
                <a class="nav-item nav-link " href="/">
                        About me
                    </a>
                
                
                
                <a class="nav-item nav-link  active" href="/blog/">
                        Blogs
                    </a>
                
                
                
                <a class="nav-item nav-link " href="/exherbo/">
                        Exherbo
                    </a>
                
                
                
                <a class="nav-item nav-link " href="/logbook/">
                        Logbooks
                    </a>
                
                
                
                <a class="nav-item nav-link " href="/skill/">
                        Skills
                    </a>
                
                
                
                <a class="nav-item nav-link " href="/talk/">
                        Talks
                    </a>
                
                
                
                <a class="nav-item nav-link " href="/wiki/">
                        Wikis
                    </a>
                
                
            </div>
            <div class="navbar-nav">
                
                
                    
                    
                    <a class="nav-item nav-link  active" href="/en">
                        en
                    </a>
                
                
                    
                    
                    <a class="nav-item nav-link " href="/fr">
                        fr
                    </a>
                
            </div>
        </div>
</nav>
</div>

        <div style="background-color:white">
        <div class="container pt-3 pb-3">

<h1 class="title mt-3 mb-3"><a href="/blog/2014/10/08/pulp-horror-fest/" class="text-gray-dark">
    A classical pulp upgrade ....
</a></h1>
<div class="content text-justify">
    

<p>Yesterday I did upgrade a pulp instance from pulp 2.2 to pulp 2.4. Here is my story&hellip;</p>

<p>Upgrading pulp seems very very simple. You update the RPMs then you run the migration script, <code>pulp-manage-db</code>. Well, at least that&rsquo;s the theory.</p>

<h4 id="first-step-packages-changes">First step: packages changes</h4>

<p>The <a href="http://pulp-user-guide.readthedocs.org/en/latest/release-notes/2.4.x.html">release note</a> tell us a couple of things: some packages to install, some configuration files to save&hellip;</p>

<p>So here we go:</p>

<ul>
<li>Install some qpid packages</li>
<li>Upgrade mongodb to 2.4</li>
<li>Set <code>auth=no</code> is needed in <code>/etc/qpid/qpidd.conf</code></li>
<li>Downgrade <code>m2crypto</code> to use distribution packages</li>
</ul>

<p>For the moment, everything is good.</p>

<h4 id="second-step-run-the-migrations">Second step: Run the migrations</h4>

<p>Here the troubles begin.</p>

<p>There is a first fail in the migration, but hopefully the fix is documented, and in 2 minutes my search engine told me what to do:</p>

<pre><code>find /var/lib/pulp/working/repos/ -path '*/yum_importer' -type d -exec rm -rf '{}' \;
</code></pre>

<p>Apparently it is because this pulp instance was migrated from a pulp 1 to a pulp 2 in the past.</p>

<p>The migration fails a second time. And there is a <a href="https://bugzilla.redhat.com/show_bug.cgi?format=multiple&amp;id=1016612">ticket</a> for that.</p>

<p>Here are the logs (these one come from the ticket but I got exactly the same behaviour):</p>

<pre><code># pulp-manage-db 
Beginning database migrations.
Migration package pulp.server.db.migrations is up to date at version 4
Migration package pulp_puppet.plugins.migrations is up to date at version 0
Applying pulp_rpm.migrations version 8
Migration to pulp_rpm.migrations version 8 complete.
Applying pulp_rpm.migrations version 9
Migration to pulp_rpm.migrations version 9 complete.
Applying pulp_rpm.migrations version 10
Migration to pulp_rpm.migrations version 10 complete.
Applying pulp_rpm.migrations version 11
Applying migration pulp_rpm.migrations.0011_new_importer failed.  See log for
details.
2013-10-08 11:52:52,924 db:CRITICAL: Applying migration
pulp_rpm.migrations.0011_new_importer failed.
2013-10-08 11:52:52,925 db:CRITICAL: 'NoneType' object has no attribute 'text'
2013-10-08 11:52:52,998 db:CRITICAL: Traceback (most recent call last):
  File &quot;/usr/lib/python2.6/site-packages/pulp/server/db/manage.py&quot;, line 79, in
    migrate_database update_current_version=not options.test)
  File &quot;/usr/lib/python2.6/site-packages/pulp/server/db/migrate/models.py&quot;,
    line 161, in apply_migration migration.migrate()
  File &quot;/usr/lib/python2.6/site-packages/pulp_rpm/migrations/0011_new_importer.py&quot;,
    line 29, in migrate _migrate_collection(type_id)
  File &quot;/usr/lib/python2.6/site-packages/pulp_rpm/migrations/0011_new_importer.py&quot;,
    line 56, in _migrate_collection package['sourcerpm'] = format_element.find('sourcerpm').text
AttributeError: 'NoneType' object has no attribute 'text'
</code></pre>

<p>The bug report was reported by one of my colleagues, and it is marked as CLOSED CURRENTRELEASE. Sorry but this is not fixed.</p>

<p>Hopefully there is a workaround in the ticket: you need to do some changes in <code>0011_new_importer.py</code> and replace</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span>package[<span style="color: #BA2121">&#39;sourcerpm&#39;</span>] <span style="color: #666666">=</span> format_element<span style="color: #666666">.</span>find(<span style="color: #BA2121">&#39;sourcerpm&#39;</span>)<span style="color: #666666">.</span>text
</pre></div>

<p>by</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #008000; font-weight: bold">try</span>:
    package[<span style="color: #BA2121">&#39;sourcerpm&#39;</span>] <span style="color: #666666">=</span> format_element<span style="color: #666666">.</span>find(<span style="color: #BA2121">&#39;sourcerpm&#39;</span>)<span style="color: #666666">.</span>text
<span style="color: #008000; font-weight: bold">except</span> <span style="color: #D2413A; font-weight: bold">AttributeError</span>:
    package[<span style="color: #BA2121">&#39;sourcerpm&#39;</span>] <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;&#39;</span>
</pre></div>

<p>At this point I start disliking pulp, but I was not at the end of my surprises.</p>

<p>I re-run the migration scripts. That step goes well. But the it is another one that is failing:</p>

<pre><code>Applying migration pulp_rpm.plugins.migrations.0016_new_yum_distributor failed.

Halting migrations due to a migration failure.
Error publishing repository centos-5-x86_64.  More than one distribution found.
Traceback (most recent call last):
  File &quot;/usr/lib/python2.6/site-packages/pulp/server/db/manage.py&quot;, line 111, in main
    _auto_manage_db(options)
  File &quot;/usr/lib/python2.6/site-packages/pulp/server/db/manage.py&quot;, line 157, in _auto_manage_db
    migrate_database(options)
  File &quot;/usr/lib/python2.6/site-packages/pulp/server/db/manage.py&quot;, line 86, in migrate_database
    update_current_version=not options.test)
  File &quot;/usr/lib/python2.6/site-packages/pulp/server/db/migrate/models.py&quot;, line 161, in apply_migration
    migration.migrate()
  File &quot;/usr/lib/python2.6/site-packages/pulp_rpm/plugins/migrations/0016_new_yum_distributor.py&quot;, line 59,

    _re_publish_repository(repo, d)
  File &quot;/usr/lib/python2.6/site-packages/pulp_rpm/plugins/migrations/0016_new_yum_distributor.py&quot;, line 165

    publisher.publish()
  File &quot;/usr/lib/python2.6/site-packages/pulp/plugins/util/publish_step.py&quot;, line 323, in publish
    self.process_lifecycle()
  File &quot;/usr/lib/python2.6/site-packages/pulp/plugins/util/publish_step.py&quot;, line 92, in process_lifecycle
    step.process()
  File &quot;/usr/lib/python2.6/site-packages/pulp/plugins/util/publish_step.py&quot;, line 148, in process
    self.initialize()
  File &quot;/usr/lib/python2.6/site-packages/pulp_rpm/plugins/distributors/yum/publish.py&quot;, line 666, in initia

    raise Exception(msg)
Exception: Error publishing repository centos-5-x86_64.  More than one distribution found.
</code></pre>

<p>More than one distribution found. And now? How do I delete the useless distributions?</p>

<p>Indeed that repo has several distributions: 5.9, 5.10, 5.11&hellip; But at this time of the migration,
the pulp server refuses to work because it is not migrated.</p>

<p>So I can not delete the distributions. And I can&rsquo;t run the migration. So I can not use pulp. So I can not delete the distribution. Which means I can not do the migration. And I can not use pulp. So I can not delete the distributions. And I can not run the migration&hellip;</p>

<p>Let&rsquo;s apply the previous workaround on that situation. In <code>0016_new_yum_distributor.py</code>, let&rsquo;s change:</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span>publisher<span style="color: #666666">.</span>publish()
</pre></div>

<p>by</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #008000; font-weight: bold">try</span>:
    publisher<span style="color: #666666">.</span>publish()
<span style="color: #008000; font-weight: bold">except</span> <span style="color: #D2413A; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> e:
    <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&quot;Ignoring exception: </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&quot;</span> <span style="color: #666666">%</span> e
</pre></div>

<p>So the migration will be considered as done, but the repos won&rsquo;t be republished.</p>

<p>And indeed it worked as expected. I could now try to find the double distributions:</p>

<pre><code>pulp-admin rpm repo content distribution --repo-id centos-5-x86_64
</code></pre>

<p>And &hellip; a new surprise: pulp only returns ONE distribution. So you don&rsquo;t know how many of them are in the repository.</p>

<p>So I needed to delete the distributions <em>one by one</em>, then re-publish the repository.</p>

<p>Some more services were needed also: <code>pulp_celerybeat</code>  <code>pulp_resource_manager</code> and  <code>pulp_workers</code>.</p>

<p>And, at the end, it worked.</p>

</div>
<div class="message mb-3">
    <div class="bg-faded p-3 text-center">
        <a href="/blog/2014/10/08/pulp-horror-fest/">Permalink</a>. Category: Linux. Tags: centos pulp planet-inuits mongodb.<br/>
        First published on Wed 8 October 2014.
    </div>
</div>

        </div>
        </div>
        <footer class="pt-2">
            <div class="text-center p-5">
                <p>Content written by Julien Pivotto, licensed under the <a rel="license" href="http://creativecommons.org/licenses/by/4.0/deed.en_US">Creative Commons Attribution 4.0 International License</a>.
</p>
                <p>Proudly generated by <a href="http://gohugo.io/">Hugo 0.25.1</a>, using <a href="http://getbootstrap.com/">Bootstrap</a> and <a href="http://pygments.org/">Pygments</a>.
</p>
                <p>This page has been generated on 2017-07-24.
</p>
            </div>
        </footer>
        <link rel="stylesheet" href="/css/bootstrap.min.css">
        <script type="text/javascript" src="/js/jquery.min.js"></script>
        <script type="text/javascript" src="/js/bootstrap.min.js"></script>
    </body>
</html>

